<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>City Phonebook</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg-1: #0b0f16;
        --bg-2: #121826;
        --accent: #6ee7ff;
        --accent-2: #a78bfa;
        --gold: #f1c27d;
        --text-1: #e8eefc;
        --text-2: #a6b0c3;
        --shadow-strong: 0 30px 80px rgba(0, 0, 0, 0.55), 0 10px 30px rgba(0, 0, 0, 0.35);
        --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.35);
        --glass: rgba(255, 255, 255, 0.06);
        --glass-strong: rgba(255, 255, 255, 0.12);
      }

      html, body {
        height: 100%;
        margin: 0;
        background: transparent; /* keep world visible until opened */
        color: var(--text-1);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow: hidden;
      }

      /* No page-wide background when opened; keep world visible */
      body.visible { background: transparent; }

      /* NUI visibility control */
      #root { opacity: 0; pointer-events: none; transition: opacity 220ms ease; }
      body.visible #root { opacity: 1; pointer-events: auto; }

      .stage {
        position: relative;
        width: 100%;
        height: 100%;
        display: grid;
        place-items: center;
        perspective: 1600px;
        perspective-origin: 50% 40%;
      }

      /* Ambient floating 3D effect for the book */
      .float-anim {
        animation: floatY 4.5s ease-in-out infinite;
      }
      @keyframes floatY { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-10px) } }

      /* Remove sparkles overlay for full transparency */

      .book-wrap {
        width: clamp(860px, 70vw, 1100px);
        height: clamp(520px, 65vh, 720px);
        transform-style: preserve-3d;
        position: relative;
        transition: transform 600ms ease;
      }

      .book {
        width: 100%;
        height: 100%;
        position: relative;
        transform-style: preserve-3d;
        transform: rotateX(6deg) rotateY(-22deg) translateZ(0);
        transition: transform 1000ms cubic-bezier(0.22, 1, 0.36, 1);
        filter: drop-shadow(0 40px 80px rgba(0,0,0,0.55));
      }
      .open .book { transform: rotateX(0deg) rotateY(0deg) translateZ(0); }

      .cover {
        position: absolute;
        inset: 0;
        background:
          linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0) 35%),
          radial-gradient(140% 140% at 10% 10%, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0) 40%),
          linear-gradient(160deg, #1a1d2a, #0d101a 60%);
        border-radius: 18px;
        overflow: hidden;
        transform: translateZ(40px);
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), inset 0 -20px 60px rgba(0,0,0,0.45);
      }
      .cover::before {
        content: "";
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(135deg, rgba(255,255,255,0.04) 0 2px, rgba(255,255,255,0.02) 2px 4px, rgba(0,0,0,0.05) 4px 6px),
                    radial-gradient(1200px 600px at 120% -20%, rgba(110,231,255,0.08), rgba(167,139,250,0.06), transparent 60%);
        mix-blend-mode: soft-light;
        pointer-events: none;
      }
      .cover::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(70deg, transparent 40%, rgba(255,255,255,0.08) 48%, rgba(255,255,255,0.22) 50%, rgba(255,255,255,0.08) 52%, transparent 60%);
        transform: translateX(-120%);
        animation: gloss 4.5s ease-in-out 0.75s infinite;
        pointer-events: none;
      }
      @keyframes gloss { 0% { transform: translateX(-120%); } 55%,100% { transform: translateX(120%); } }

      .spine {
        position: absolute;
        left: -24px;
        top: 8px;
        bottom: 8px;
        width: 28px;
        background: linear-gradient(90deg, #0f1420, #161b2a);
        border-radius: 10px 0 0 10px;
        box-shadow: inset -2px 0 0 rgba(255,255,255,0.05);
        transform: translateZ(22px);
      }

      /* emblem removed; using logo only */

      .brand {
        position: absolute;
        right: 24px;
        top: 18px;
        transform: translateZ(60px);
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .brand img { height: 54px; width: 54px; border-radius: 999px; box-shadow: 0 6px 18px rgba(0,0,0,0.35); }

      .title {
        position: absolute;
        left: 100px;
        top: 30px;
        right: 22px;
        height: 60px;
        display: flex;
        align-items: center;
        gap: 12px;
        transform: translateZ(60px);
      }
      .title h1 {
        margin: 0;
        font-size: clamp(22px, 2.6vw, 34px);
        font-weight: 700;
        letter-spacing: 0.6px;
        color: var(--text-1);
      }
      .title .badge {
        margin-top: 3px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.5px;
        background: linear-gradient(90deg, rgba(110,231,255,0.16), rgba(167,139,250,0.16));
        outline: 1px solid rgba(110,231,255,0.22);
        color: #d7f9ff;
        white-space: nowrap;
      }

      .pages {
        position: absolute;
        inset: 0;
        padding: 110px 28px 24px 28px;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 18px;
        transform: translateZ(50px);
      }

      .toolbar { display: flex; gap: 12px; align-items: center; }

      .search {
        flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-radius: 12px;
        background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
        border: 1px solid rgba(255,255,255,0.14);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), inset 0 -8px 16px rgba(0,0,0,0.25);
      }
      .search input { flex: 1; background: transparent; border: none; color: var(--text-1); outline: none; font-size: 14px; }

      .btn {
        appearance: none; border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 600; color: #0c1020;
        background: linear-gradient(180deg, #c2f3ff, #7adfff);
        box-shadow: 0 6px 16px rgba(110,231,255,0.35), inset 0 -2px 6px rgba(0,0,0,0.15);
        cursor: pointer;
      }

      .list { position: relative; overflow: hidden; border-radius: 16px; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); border: 1px solid rgba(255,255,255,0.12); box-shadow: var(--shadow-soft), inset 0 0 0 1px rgba(255,255,255,0.05); display: grid; grid-template-rows: auto 1fr; }
      .list-head { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; padding: 14px 16px; font-size: 12px; letter-spacing: 0.6px; color: var(--text-2); text-transform: uppercase; background: linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0)); border-bottom: 1px solid rgba(255,255,255,0.08); }
      .list-body { overflow: auto; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.24) transparent; }
      .list-body::-webkit-scrollbar { width: 10px; }
      .list-body::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08)); border-radius: 10px; }

      .row { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; padding: 14px 16px; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(3px); transition: background 180ms ease, transform 120ms ease, opacity 220ms ease; opacity: 0; transform: translateY(4px); will-change: transform, opacity; }
      .row:hover { background: rgba(255,255,255,0.06); transform: translateZ(0) scale(1.002); }
      .row.appear { opacity: 1; transform: translateY(0); }
      .name { font-weight: 600; }
      .number { font-variant-numeric: tabular-nums; color: #d6e3ff; }

      .empty, .hint { padding: 20px; color: var(--text-2); text-align: center; }

      .pager { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding-top: 8px; }
      .pager .info { color: var(--text-2); font-size: 13px; }
      .pager .controls { display: flex; gap: 8px; }
      .pager button { appearance: none; border: 0; border-radius: 10px; padding: 8px 12px; font-weight: 600; color: #0c1020; background: linear-gradient(180deg, #e8f4ff, #bcdcff); box-shadow: 0 4px 10px rgba(110,231,255,0.2), inset 0 -2px 6px rgba(0,0,0,0.12); cursor: pointer; }
      .pager button:disabled { opacity: 0.5; cursor: default; }

      .footer { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 4px 0 4px; color: var(--text-2); }
      .signature { font-weight: 600; letter-spacing: 0.4px; text-transform: uppercase; color: rgba(241,194,125,0.9); }

      @media (max-width: 980px) { .book-wrap { width: 92vw; height: 72vh; } .spine { left: -18px; width: 22px; } }
      @media (max-width: 720px) { .book-wrap { width: 94vw; height: 76vh; } .title h1 { font-size: 20px; } }
    </style>
  </head>
  <body>
    <div class="stage" id="root">
      <div class="book-wrap float-anim open" id="bookWrap">
        <div class="book" id="book">
          <div class="spine"></div>
          <div class="cover">
            <div class="brand">
              <img id="logoImg" alt="Server logo" />
            </div>
            <div class="title">
              <h1 id="titleText">City Phonebook</h1>
              <div class="badge">Online</div>
            </div>
            <div class="pages">
              <div class="toolbar">
                <div class="search">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="white" stroke-opacity="0.7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <input id="search" type="text" placeholder="Search by name or number..." />
                </div>
                <button class="btn" id="closeBtn">Close</button>
              </div>
              <div class="list">
                <div class="list-head"><div>Name</div><div>Number</div></div>
                <div class="list-body" id="listBody"></div>
              </div>
              <div class="pager">
                <div class="info" id="pageInfo">Type at least 3 characters to search</div>
                <div class="controls">
                  <button class="btn" id="prevBtn" disabled>Prev</button>
                  <button class="btn" id="nextBtn" disabled>Next</button>
                </div>
              </div>
              <div class="footer">
                <div>Press ESC or Close to exit</div>
                <div class="signature">Created by OLRP</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const listBody = document.getElementById('listBody');
      const searchInput = document.getElementById('search');
      const closeBtn = document.getElementById('closeBtn');
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      let contacts = [];
      let filtered = [];
      let currentPage = 1;
      const pageSize = 10;

      function setPager(total) {
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        currentPage = Math.min(currentPage, totalPages);
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
        if (total === 0) {
          pageInfo.textContent = 'No results';
        } else {
          const start = (currentPage - 1) * pageSize + 1;
          const end = Math.min(total, currentPage * pageSize);
          pageInfo.textContent = `Showing ${start}-${end} of ${total}`;
        }
      }

      function renderPage() {
        listBody.innerHTML = '';
        if (filtered.length === 0) {
          const hint = document.createElement('div');
          hint.className = 'hint';
          hint.textContent = searchInput.value.trim().length < 3 ? 'Type at least 3 characters to search' : 'No results';
          listBody.appendChild(hint);
          setPager(0);
          return;
        }
        const start = (currentPage - 1) * pageSize;
        const end = Math.min(filtered.length, start + pageSize);
        for (let i = start; i < end; i++) {
          const c = filtered[i];
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `<div class="name">${c.name}</div><div class="number">${c.number}</div>`;
          listBody.appendChild(row);
          requestAnimationFrame(() => row.classList.add('appear'));
        }
        setPager(filtered.length);
      }

      function applyFilter(term) {
        const t = term.trim().toLowerCase();
        if (t.length < 3) {
          filtered = [];
          currentPage = 1;
          renderPage();
          return;
        }
        filtered = contacts.filter(c => c.name.toLowerCase().includes(t) || String(c.number).includes(t));
        currentPage = 1;
        renderPage();
      }

      function debounce(fn, delay) {
        let timer; return function(...args) { clearTimeout(timer); timer = setTimeout(() => fn.apply(this, args), delay); };
      }

      function openUI(newContacts) {
        contacts = Array.isArray(newContacts) ? newContacts : [];
        filtered = [];
        currentPage = 1;
        renderPage();
        document.body.classList.add('visible');
      }

      function closeUI() {
        fetch(`https://${GetParentResourceName()}/close`, { method: 'POST', body: '{}' });
      }

      // Receive messages from client
      window.addEventListener('message', (event) => {
        const { action, contacts: payload } = event.data || {};
        if (action === 'open') {
          openUI(payload || []);
        }
        if (action === 'close') {
          // Just fade out rows quickly
          document.querySelectorAll('.row').forEach(r => r.classList.remove('appear'));
          document.body.classList.remove('visible');
        }
      });

      // Search with debounce and 3-char threshold
      searchInput.addEventListener('input', debounce((e) => applyFilter(e.target.value), 200));

      // Paging handlers
      prevBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPage(); } });
      nextBtn.addEventListener('click', () => { currentPage++; renderPage(); });
      

      // Close button
      closeBtn.addEventListener('click', () => closeUI());

      // ESC key
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeUI();
        }
      });

      // Dynamically set logo path from resource
      (function setLogo() {
        try {
          const resName = GetParentResourceName ? GetParentResourceName() : null;
          if (!resName) return;
          const img = document.getElementById('logoImg');
          if (img) img.src = `nui://${resName}/logo.png`;
        } catch (_) { /* ignore in browser preview */ }
      })();
    </script>
  </body>
  </html>


